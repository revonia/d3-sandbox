<!DOCTYPE html>
<html style="height: 100%">
<head>
  <meta charset="UTF-8">
  <title>Preview</title>
  <script type="application/javascript">

    window.addEventListener("message", function (event) {
      const order = ['css', 'html', 'resource', 'json', 'javascript']
      let data = [...event.data]
      data.sort((a, b) => {
        return order.indexOf(a.type) - order.indexOf(b.type)
      })
      data.forEach(item => $$loadResource(item.type, item.source))
    }, false);

    var jsonResource = {}

    function $$loadResource (type, content) {
      switch (type) {
        case 'javascript':
          try {
            eval(content)
          } catch (e) {
            const pre = document.createElement("pre");
            pre.appendChild(document.createTextNode(e));
            document.body.insertBefore(pre, document.body.firstChild);
          }
          break;
        case 'css':
          const tag = document.createElement("style");
          tag.innerHTML = content;
          document.head.appendChild(tag);
          break;
        case 'html':
          document.body.innerHTML += content
          break;
        case 'json':
          jsonResource = JSON.parse(content)
          break;
        case 'resource':
          content.split('\n').forEach((src) => {
            let tag
            if (src.endsWith('.js')) {
              tag = document.createElement('script')
              tag.src = src
              tag.type = 'application/javascript'
              document.head.append(tag)
            } else if (src.endsWith('.css')) {
              tag = document.createElement('link')
              tag.type = 'stylesheet'
              tag.href = src
              document.head.append(tag)
            }
          })
          break;
      }
    }
  </script>
</head>
<body>
</body>
</html>
